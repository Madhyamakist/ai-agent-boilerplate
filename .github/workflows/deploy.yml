name: Deploy Python App to GCP E2 (Staging)

on:
  push:
    branches:
      - main
      - deploy   # change if you want a different branch for staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy-staging   # matches the environment you created in GitHub

    steps:
      - uses: 'actions/checkout@v4' # Checkout your repository
      - uses: 'google-github-actions/auth@v2' # Authenticate to Google Cloud
        with:
          project_id: ${{ secrets.GCP_PROJECT }} # Replace with your actual GCP project ID
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Start VM Instance (if stopped)'
        run: |
          gcloud compute instances start ${{ secrets.GCP_VM_INSTANCE_NAME }} \
            --zone=${{ secrets.GCP_ZONE }} || echo "VM already running"

      - name: 'Deploy Application'
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_INSTANCE_NAME }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --command="cd ~/Ai-agent-boilerplate/ai-agent-boilerplate && chmod +x deploy.sh && ./deploy.sh deploy" \
            --ssh-flag="-o StrictHostKeyChecking=no"

      - name: 'Verify Deployment'
        run: |
          # Get external IP
          EXTERNAL_IP=$(gcloud compute instances describe ${{ secrets.GCP_VM_INSTANCE_NAME }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "Application deployed at: http://$EXTERNAL_IP"